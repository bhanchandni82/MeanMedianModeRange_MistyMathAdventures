<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mitsy Math Martial Arts Academy</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Bangers&display=swap');

    :root {
      --shoji-paper: #fefaf0;
      --wood-dark: #4a3728;
      --wood-light: #8b5e34;
      --accent-red: #dc2626;
    }

    body { 
      font-family: 'Nunito', sans-serif;
      background-color: #121212;
      color: #1e293b;
      margin: 0;
      display: flex;
      justify-content: center;
      overflow-x: hidden;
      cursor: default;
    }

    .dojo-container {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      height: 100dvh;
      background: var(--shoji-paper);
      position: relative;
      overflow: hidden;
      display: flex; flex-direction: column;
    }

    .shoji-wall {
      position: absolute; top: 0; left: 0; right: 0; height: 100%;
      background-color: var(--shoji-paper);
      background-image: 
        linear-gradient(rgba(74, 55, 40, 0.08) 2px, transparent 2px),
        linear-gradient(90deg, rgba(74, 55, 40, 0.08) 2px, transparent 2px);
      background-size: 50px 70px;
      z-index: 1;
    }

    .wood-floor-bg {
      position: absolute; bottom: 0; left: 0; right: 0; height: 32%;
      background: linear-gradient(to bottom, #5d4037, #3e2723);
      z-index: 2;
      box-shadow: inset 0 10px 20px rgba(0,0,0,0.5);
      border-top: 4px solid #2a1a0a;
    }

    .btn-3d {
      position: relative; 
      transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
      border-radius: 1.25rem;
      font-weight: 900; 
      text-transform: uppercase; 
      letter-spacing: 0.05em;
      color: white; 
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn-3d:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 0 var(--shadow-color) !important;
      filter: brightness(1.05);
    }

    .btn-3d:active { 
      transform: translateY(6px); 
      box-shadow: 0 2px 0 var(--shadow-color) !important;
      transition: all 0.05s ease-out;
    }

    .btn-mean { --shadow-color: #4338ca; background: #6366f1; box-shadow: 0 8px 0 #4338ca; }
    .btn-median { --shadow-color: #059669; background: #10b981; box-shadow: 0 8px 0 #059669; }
    .btn-mode { --shadow-color: #d97706; background: #f59e0b; box-shadow: 0 8px 0 #d97706; }
    .btn-range { --shadow-color: #be185d; background: #ec4899; box-shadow: 0 8px 0 #be185d; }
    .btn-white { --shadow-color: #cbd5e1; background: #f8fafc; color: #475569; box-shadow: 0 8px 0 #cbd5e1; }
    .btn-black { --shadow-color: #000000; background: #1e293b; box-shadow: 0 8px 0 #000000; }

    .floating-mitsy {
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
    }
    .mitsy-shadow {
      width: 180px; height: 25px; background: rgba(0,0,0,0.2);
      border-radius: 50%; margin: -20px auto 0; filter: blur(12px);
      animation: shadow-scale 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-35px); }
    }
    @keyframes shadow-scale {
      0%, 100% { transform: scale(1); opacity: 0.4; }
      50% { transform: scale(0.6); opacity: 0.15; }
    }

    .sunburst-container {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 100%; height: 100%; z-index: 0; overflow: hidden; pointer-events: none;
    }
    .sunburst-bg {
      position: absolute; width: 800px; height: 800px;
      left: calc(50% - 400px); top: calc(50% - 400px);
      background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0.15) 0deg 15deg, transparent 15deg 30deg);
      animation: rotate 25s linear infinite;
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .academy-banner { 
        background: var(--accent-red); 
        position: relative; 
        border-bottom: 8px solid #7f1d1d; 
        z-index: 10;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .academy-title { 
        font-family: 'Bangers', cursive; 
        font-size: 32px; 
        color: white; 
        transform: skew(-5deg); 
        text-shadow: 3px 3px 0px #7f1d1d; 
        position: relative; 
        z-index: 10;
        text-align: center;
        line-height: 1.1;
    }

    .highlighter-title {
      position: relative; 
      font-weight: 900; 
      font-size: 16px;
      text-transform: uppercase; 
      color: #1e293b; 
      display: inline-block;
      padding: 0 8px;
      z-index: 5;
    }
    .highlighter-title::after {
      content: ''; 
      position: absolute; 
      bottom: 0px; 
      left: 0; 
      width: 100%;
      height: 16px; 
      z-index: -1; 
      transform: rotate(-1deg); 
      opacity: 0.8;
      border-radius: 4px 12px 4px 10px;
    }
    .hl-blue::after { background: #bae6fd; }
    .hl-gold::after { background: #fef08a; }

    .blackboard {
      position: fixed; 
      top: 0;
      left: 50%;
      transform: translate(-50%, 100%);
      width: 100%;
      max-width: 480px;
      background: #1a1a1a; 
      z-index: 9999;
      display: flex; 
      flex-direction: column; 
      transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      height: 100%;
      max-height: 100%;
    }
    .blackboard.active { transform: translate(-50%, 0); }
    
    .char { opacity: 0; animation: fadeIn 0.05s forwards; display: inline; }
    @keyframes fadeIn { to { opacity: 1; } }
    .hidden { display: none !important; }

    .bb-step-label { color: #10b981; font-weight: 900; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }
    .bb-step-text { color: rgba(255,255,255,0.85); font-size: 15px; margin-bottom: 6px; line-height: 1.4; }
    .bb-step-res { color: #fbbf24; font-weight: 900; font-size: 24px; }

    .progress-bar {
      display: flex;
      gap: 4px;
      width: 100%;
      margin-bottom: 1.5rem;
    }
    .progress-step {
      flex: 1;
      height: 6px;
      background: #e2e8f0;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    .progress-step.correct { background: #6366f1; }
    .progress-step.wrong { background: #ec4899; }
  </style>
</head>

<body>
  <div class="dojo-container">
    <div class="shoji-wall"></div>
    <div class="wood-floor-bg"></div>

    <div class="relative z-10 flex flex-col h-full">
      <header class="academy-banner py-4 px-6 overflow-hidden flex-shrink-0">
        <div class="sunburst-container">
            <div class="sunburst-bg"></div>
        </div>
        <h1 class="academy-title tracking-widest">MITSY MATH MARTIAL ARTS ACADEMY</h1>
      </header>

      <!-- Home View -->
      <div id="home-view" class="flex-grow flex flex-col relative overflow-hidden">
        <div class="px-6 pt-4 z-10">
          <div class="mb-3">
            <span class="highlighter-title hl-blue">Fixing Fundamentals</span>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="startQuiz('Mean')" class="btn-3d btn-mean py-3 text-sm font-black">Mean</button>
            <button onclick="startQuiz('Median')" class="btn-3d btn-median py-3 text-sm font-black">Median</button>
            <button onclick="startQuiz('Mode')" class="btn-3d btn-mode py-3 text-sm font-black">Mode</button>
            <button onclick="startQuiz('Range')" class="btn-3d btn-range py-3 text-sm font-black">Range</button>
          </div>
        </div>

        <div class="flex-grow flex flex-col items-center justify-center z-10 py-2">
          <img src="https://github.com/bhanchandni82/MeanMedianModeRange_MistyMathAdventures/blob/main/MitsyKarateChamp-removebg-preview.png?raw=true" class="w-72 h-72 object-contain floating-mitsy">
          <div class="mitsy-shadow"></div>
        </div>

        <div class="px-6 pb-40 flex flex-col justify-end z-10 -mt-20">
          <div class="mb-3">
            <span class="highlighter-title hl-gold">Mastering Mock Test</span>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="startQuiz('WhiteBelt')" class="btn-3d btn-white py-4 text-sm font-black">WHITE BELT</button>
            <button onclick="startQuiz('BlackBelt')" class="btn-3d btn-black py-4 text-sm font-black">BLACK BELT</button>
          </div>
        </div>
      </div>

      <!-- Quiz View -->
      <div id="quiz-view" class="hidden flex-grow flex flex-col p-4 relative z-20 overflow-y-auto">
        <div class="bg-white/95 rounded-[2.5rem] shadow-2xl flex-shrink-0 flex flex-col p-6 border-b-[6px] border-slate-200 mb-4">
          <div class="flex justify-between items-center mb-4">
            <button onclick="showHome()" class="text-slate-400 font-bold text-xs flex items-center gap-1 hover:text-slate-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> DOJO</button>
            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest" id="question-counter">1 / 10</div>
          </div>

          <div id="progress-bar" class="progress-bar"></div>

          <div id="number-set" class="flex flex-wrap justify-center gap-3 mb-6"></div>
          <h2 id="question-text" class="text-2xl font-black text-slate-800 text-center mb-6 leading-tight"></h2>
          <div id="options-grid" class="space-y-4 pb-4"></div>
        </div>
      </div>

      <!-- Results View -->
      <div id="results-view" class="hidden flex-grow flex items-center justify-center p-6 text-center z-20">
        <div class="bg-white rounded-[3rem] p-10 shadow-2xl space-y-6 w-full border-b-[8px] border-slate-200">
          <h2 class="text-3xl font-black text-slate-900">TRAINING COMPLETE</h2>
          <div id="final-score" class="text-2xl font-bold text-indigo-600"></div>
          <button onclick="showHome()" class="btn-3d btn-black w-full py-5 text-sm font-black">Return to Academy</button>
        </div>
      </div>
    </div>
  </div>

  <div id="blackboard" class="blackboard">
    <div class="p-4 border-b border-white/5 bg-zinc-900 flex-shrink-0 flex justify-between items-center">
      <span class="text-[10px] font-black text-yellow-500 uppercase flex items-center gap-2">
        <i data-lucide="award" class="w-3 h-3"></i> Sensei's Correction
      </span>
    </div>
    <div id="blackboard-content" class="flex-1 p-6 overflow-y-auto space-y-8 text-white font-mono text-sm scroll-smooth" style="-webkit-overflow-scrolling: touch;"></div>
    <div class="p-4 bg-zinc-900 border-t border-white/5 flex-shrink-0 flex gap-3">
      <button onclick="nextQuestion()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 hover:bg-indigo-500 shadow-lg">
        NEXT QUESTION <i data-lucide="arrow-right" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <script>
    let currentQuiz = null;
    let isProcessing = false;

    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const shuffle = (arr) => {
      const result = [...arr];
      for (let i = result.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [result[i], result[j]] = [result[j], result[i]];
      }
      return result;
    };
    const sum = (arr) => arr.reduce((a, b) => a + b, 0);

    const Generators = {
      // FUNDAMENTAL MODULES - Logic updated for 4-7 number range
      Mean: () => {
        const dataSize = randInt(4, 7);
        const data = Array.from({ length: dataSize }, () => randInt(2, 12));
        const total = sum(data);
        const result = (total / dataSize).toFixed(1).replace(/\.0$/, '');
        return {
          data, questionText: `What is the Mean of this set of ${dataSize} numbers?`, correctAnswer: String(result),
          howTo: "To find the mean, we first find the grand total and then divide by the count.",
          steps: [
            { label: "Step 1", ins: `Find the grand total by adding the numbers: ${data.join(" + ")}`, res: String(total) },
            { label: "Step 2", ins: `Now divide that total by the count (${dataSize}): ${total} ÷ ${dataSize}`, res: String(result) }
          ]
        };
      },
      Median: () => {
        const dataSize = randInt(4, 7);
        const data = Array.from({ length: dataSize }, () => randInt(2, 20));
        const sorted = [...data].sort((a, b) => a - b);
        let ans;
        let step2Text;
        if (dataSize % 2 !== 0) {
            ans = String(sorted[Math.floor(dataSize / 2)]);
            step2Text = `Since we have an odd count (${dataSize}), the median is the middle number.`;
        } else {
            const m1 = sorted[dataSize / 2 - 1];
            const m2 = sorted[dataSize / 2];
            ans = String((m1 + m2) / 2);
            step2Text = `Since we have an even count (${dataSize}), we average the two middle numbers: (${m1} + ${m2}) ÷ 2`;
        }
        return {
          data, questionText: "Find the Median (Middle Number)", correctAnswer: ans,
          howTo: "The median is the number sitting in the exact center once the set is lined up in order.",
          steps: [
            { label: "Step 1", ins: "Line up the numbers from smallest to largest to see the true order.", res: sorted.join(", ") },
            { label: "Step 2", ins: step2Text, res: ans }
          ]
        };
      },
      Mode: () => {
        const dataSize = randInt(4, 7);
        const base = randInt(2, 10);
        const data = [base, base, ...Array.from({ length: dataSize - 2 }, () => randInt(11, 20))];
        const shuffled = shuffle(data);
        return {
          data: shuffled, questionText: "Which is the Mode?", correctAnswer: String(base),
          howTo: "The mode is the number that shows up most often. It's the most popular number in the set!",
          steps: [
            { label: "Step 1", ins: `Scan the list for any 'twins' or 'triplets'. Here, the number ${base} appears more than anything else.`, res: String(base) }
          ]
        };
      },
      Range: () => {
        const dataSize = randInt(4, 7);
        const data = Array.from({ length: dataSize }, () => randInt(2, 25));
        const mx = Math.max(...data), mn = Math.min(...data);
        return {
          data, questionText: "Calculate the Range", correctAnswer: String(mx - mn),
          howTo: "Range is the 'gap' or distance between the highest  and the lowest number.",
          steps: [
            { label: "Step 1", ins: `Identify our boundaries. The highest is ${mx} and the lowest is ${mn}.`, res: `${mx}, ${mn}` },
            { label: "Step 2", ins: `Find the distance by subtracting the low from the high: ${mx} - ${mn}`, res: String(mx - mn) }
          ]
        };
      },

      // BLACK BELT ADVANCED MODULES (Existing high-quality logic)
      BlackBelt_Mean_Context: () => {
        const names = ["Sam", "Alex", "Jordan", "Taylor", "Mitsy"];
        const name = names[randInt(0, names.length - 1)];
        const count = randInt(4, 7);
        const data = Array.from({ length: count }, () => randInt(5, 10));
        const total = sum(data);
        const ans = (total / count).toFixed(1).replace(/\.0$/, '');
        return {
          id: 'BlackBelt_Mean_Context',
          data, questionText: `${name}'s scores are ${data.join(", ")}. What is their average score?`, correctAnswer: String(ans),
          howTo: "To find the average in a story, first pull out the numbers then sum and divide.",
          steps: [
            { label: "Step 1", ins: "Sum the scores from the story.", res: String(total) },
            { label: "Step 2", ins: `Divide the sum by the count (${count}).`, res: ans }
          ]
        };
      },
      BlackBelt_Mean_Missing: () => {
        const count = randInt(4, 7); const mean = randInt(6, 10); const targetTotal = count * mean;
        const data = Array.from({ length: count - 1 }, () => randInt(2, 12));
        const currentSum = sum(data);
        const missing = targetTotal - currentSum;
        return {
          id: 'BlackBelt_Mean_Missing',
          data: [...data, "y"], questionText: `The mean of these ${count} numbers is ${mean}. Find y.`, correctAnswer: String(missing),
          howTo: "Work backwards! If you know the mean, you can find the total sum required.",
          steps: [
            { label: "Step 1", ins: `Total needed: Mean (${mean}) × Count (${count})`, res: String(targetTotal) },
            { label: "Step 2", ins: `Add known numbers: ${data.join(" + ")}`, res: String(currentSum) },
            { label: "Step 3", ins: `Subtract: ${targetTotal} - ${currentSum}`, res: String(missing) }
          ]
        };
      },
      BlackBelt_Mean_Shift: () => {
        const count = randInt(4, 7); const oldMean = randInt(5, 10); const increase = count; 
        const data = Array.from({ length: count }, () => oldMean); 
        const newMean = oldMean + (increase / count);
        return {
          id: 'BlackBelt_Mean_Shift',
          data, questionText: `The mean of ${count} scores was ${oldMean}. One score increases by ${increase}. What is the new mean?`, correctAnswer: String(newMean),
          howTo: "When a total increases, the average also increases, but the 'gain' is shared across all numbers.",
          steps: [
            { label: "Step 1", ins: `Spread change over count: ${increase} ÷ ${count}`, res: String(increase/count) },
            { label: "Step 2", ins: `New mean = old mean + change: ${oldMean} + ${increase/count}`, res: String(newMean) }
          ]
        };
      },
      BlackBelt_Median_Even: () => {
        const dataSize = randInt(2, 3) * 2; 
        const start = randInt(2, 10);
        const data = Array.from({ length: dataSize }, (_, i) => start + (i * randInt(2, 4)));
        const midIdx = dataSize / 2;
        const m1 = data[midIdx - 1], m2 = data[midIdx];
        const ans = String((m1 + m2) / 2);
        return {
          id: 'BlackBelt_Median_Even',
          data, questionText: "Find the Median of this set.", correctAnswer: ans,
          howTo: "When the count is even, there is no single middle number. We find the average of the two middle values.",
          steps: [
            { label: "Step 1", ins: `The set is sorted. With ${dataSize} numbers, the two middle seats are ${m1} and ${m2}.`, res: `${m1}, ${m2}` },
            { label: "Step 2", ins: `Average the two middle: (${m1} + ${m2}) ÷ 2`, res: ans }
          ]
        };
      },
      BlackBelt_Median_Target: () => {
        const dataSize = pick([5, 7]);
        const target = randInt(8, 12);
        const data = Array.from({ length: dataSize }, (_, i) => {
          if (i === Math.floor(dataSize / 2)) return "x";
          if (i < dataSize / 2) return randInt(1, target - 1);
          return randInt(target + 1, target + 10);
        });
        return {
          id: 'BlackBelt_Median_Target',
          data, questionText: `The median of these ${dataSize} numbers is ${target}. Which value could x be?`, correctAnswer: String(target),
          howTo: `In a set of ${dataSize}, the median is the middle number when sorted.`,
          steps: [
            { label: "Step 1", ins: `To reach the goal median of ${target}, the middle slot must be ${target}.`, res: String(target) }
          ]
        };
      },
      BlackBelt_Mode_Multi: () => {
        const m1 = randInt(2, 5); const m2 = randInt(6, 9);
        const dataSize = randInt(5, 7);
        let data = [m1, m1, m2, m2];
        while(data.length < dataSize) {
           let r = randInt(10, 20);
           if(!data.includes(r)) data.push(r);
        }
        const ans = `${m1} and ${m2}`;
        return {
          id: 'BlackBelt_Mode_Multi',
          data: shuffle(data), questionText: "What are the modes of this set?", correctAnswer: ans,
          howTo: "If two different numbers share the highest frequency, they are both the mode!",
          steps: [
            { label: "Step 1", ins: `Count frequencies: ${m1} and ${m2} both appear twice. Everything else once.`, res: ans }
          ]
        };
      },
      BlackBelt_Mode_Missing: () => {
        const target = randInt(5, 10);
        const other = target === 5 ? 6 : 5;
        const dataSize = randInt(4, 6);
        let data = [other, other, target];
        while(data.length < dataSize) data.push(randInt(11, 20));
        data.push("x");
        return {
          id: 'BlackBelt_Mode_Missing',
          data: shuffle(data), questionText: `Find x so that ${target} becomes the mode.`, correctAnswer: String(target),
          howTo: "The mode must be the most frequent. We need to add enough of the target to overtake other numbers.",
          steps: [
            { label: "Step 1", ins: `Currently ${other} has a lead. To make ${target} the mode, x must be ${target}.`, res: String(target) }
          ]
        };
      },
      BlackBelt_Range_Missing: () => {
        const count = randInt(4, 7);
        const targetRange = randInt(8, 12);
        const maxVal = randInt(15, 25);
        const minVal = maxVal - targetRange;
        let data = [maxVal];
        for(let i=0; i<count-2; i++) data.push(randInt(minVal + 1, maxVal - 1));
        data.push("x");
        return {
          id: 'BlackBelt_Range_Missing',
          data: shuffle(data), questionText: `The range is ${targetRange}. If ${maxVal} is the maximum, what is x?`, correctAnswer: String(minVal),
          howTo: "Range is Max - Min. If you have the range and the Max, you can find the Min.",
          steps: [
            { label: "Step 1", ins: `Max - x = Range. So: ${maxVal} - x = ${targetRange}`, res: String(maxVal - targetRange) }
          ]
        };
      },
      BlackBelt_Range_MCQ: () => {
        const count = randInt(4, 7);
        const targetRange = randInt(8, 12);
        const minVal = randInt(2, 8);
        const maxVal = minVal + targetRange;
        let data = [minVal];
        for(let i=0; i<count-2; i++) data.push(randInt(minVal + 1, maxVal - 1));
        data.push("x");
        return {
          id: 'BlackBelt_Range_MCQ',
          data: shuffle(data), questionText: `Range is ${targetRange}. If ${minVal} is the minimum, which value could x be?`, correctAnswer: String(maxVal),
          howTo: "If x is the maximum: x - Min = Range.",
          steps: [
            { label: "Step 1", ins: `Min is ${minVal}. Goal Range is ${targetRange}. x - ${minVal} = ${targetRange}`, res: String(maxVal) }
          ]
        };
      },
      BlackBelt_Identify_Spread: () => {
        return {
          id: 'BlackBelt_Identify_Spread',
          data: [], questionText: "Which statistical measure tells us about the 'spread' or distance between extremes?", correctAnswer: "Range",
          howTo: "Think of keywords: Middle (Median), Average (Mean), Most (Mode), Spread (Range).",
          steps: [
            { label: "Step 1", ins: "Look for keywords: 'Spread' or 'Difference between largest and smallest'.", res: "Range" }
          ]
        };
      }
    };

    function startQuiz(belt) {
      const qList = [];
      const isBlack = belt === 'BlackBelt';
      
      const blackBeltPool = [
        'BlackBelt_Mean_Context', 'BlackBelt_Mean_Missing', 'BlackBelt_Mean_Shift',
        'BlackBelt_Median_Even', 'BlackBelt_Median_Target', 
        'BlackBelt_Mode_Multi', 'BlackBelt_Mode_Missing', 
        'BlackBelt_Range_Missing', 'BlackBelt_Range_MCQ',
        'BlackBelt_Identify_Spread'
      ];

      if (isBlack) {
          const shuffledPool = shuffle(blackBeltPool);
          for(let i=0; i<10; i++) {
              qList.push(Generators[shuffledPool[i]]());
          }
      } else {
          for(let i=0; i<10; i++) {
            const type = belt === 'WhiteBelt' ? pick(['Mean','Median','Mode','Range']) : belt;
            qList.push(Generators[type]());
          }
      }

      currentQuiz = { questions: qList, currentIndex: 0, score: 0, history: [], belt };
      
      const pb = document.getElementById('progress-bar');
      pb.innerHTML = '';
      for(let i=0; i<10; i++) {
        const step = document.createElement('div');
        step.className = 'progress-step';
        step.id = `pb-step-${i}`;
        pb.appendChild(step);
      }

      document.getElementById('home-view').classList.add('hidden');
      document.getElementById('quiz-view').classList.remove('hidden');
      renderQuestion();
    }

    function pick(arr) { return arr[randInt(0, arr.length-1)]; }

    function renderQuestion() {
      isProcessing = false;
      const q = currentQuiz.questions[currentQuiz.currentIndex];
      document.getElementById('blackboard').classList.remove('active');
      document.getElementById('question-counter').textContent = `${currentQuiz.currentIndex + 1} / 10`;
      
      const nSet = document.getElementById('number-set'); nSet.innerHTML = '';
      if (q.data && q.data.length > 0) {
        q.data.forEach((n, i) => {
          const div = document.createElement('div');
          div.className = "w-10 h-10 md:w-12 md:h-12 bg-white rounded-2xl flex items-center justify-center text-sm md:text-lg font-black text-indigo-700 shadow-sm border-2 border-indigo-50 transform rotate-" + (i%2 === 0 ? '1' : '-1');
          div.textContent = n; nSet.appendChild(div);
        });
      }

      document.getElementById('question-text').textContent = q.questionText;
      const grid = document.getElementById('options-grid'); grid.innerHTML = '';
      
      let opts = [];
      
      if (q.id === 'BlackBelt_Mode_Multi') {
          const correct = q.correctAnswer;
          const pair2 = `${randInt(11, 15)} and ${randInt(16, 20)}`;
          const single = String(randInt(21, 25));
          opts = shuffle([correct, pair2, single]);
      } 
      else if (q.id === 'BlackBelt_Identify_Spread') {
          const vocab = ["Mean", "Median", "Mode", "Range"];
          opts = shuffle(vocab);
      }
      else if (currentQuiz.belt === 'BlackBelt') {
          const ans = q.correctAnswer;
          const distractors = new Set();
          while(distractors.size < 2) {
             let d = String(parseFloat(ans) + pick([-2, -1, 1, 2, 3, 5]));
             if(d !== ans && d > 0) distractors.add(d);
          }
          opts = shuffle([ans, ...Array.from(distractors)]);
      }
      else {
        const isTextAnswer = isNaN(q.correctAnswer) && !q.correctAnswer.includes('.');
        if (isTextAnswer) {
            const vocab = ["Mean", "Median", "Mode", "Range", "Average", "Sum"];
            const others = vocab.filter(v => v !== q.correctAnswer);
            opts = shuffle([q.correctAnswer, ...shuffle(others).slice(0, 2)]);
        } else {
            opts = shuffle([...new Set([q.correctAnswer, String(randInt(1, 25)), String(randInt(1, 25))])]).slice(0, 3);
        }
      }
      
      opts.forEach(opt => {
        const b = document.createElement('button');
        b.className = "w-full p-4 md:p-5 rounded-2xl bg-slate-50 border-2 border-slate-100 font-black text-base md:text-lg text-slate-700 hover:bg-white hover:border-indigo-200 transition-all active:scale-[0.98]";
        b.textContent = opt; b.onclick = () => handleAnswer(b, opt); grid.appendChild(b);
      });
      document.getElementById('quiz-view').scrollTop = 0;
    }

    function handleAnswer(btn, val) {
      if(isProcessing) return; isProcessing = true;
      const q = currentQuiz.questions[currentQuiz.currentIndex];
      const stepEl = document.getElementById(`pb-step-${currentQuiz.currentIndex}`);

      if(String(val) === String(q.correctAnswer)) {
        btn.classList.add('!bg-emerald-500', '!text-white', '!border-emerald-600');
        stepEl.classList.add('correct');
        currentQuiz.score++; 
        confetti({ particleCount: 50, spread: 70, origin: { y: 0.7 } }); 
        setTimeout(nextQuestion, 1000);
      } else {
        btn.classList.add('!bg-rose-500', '!text-white', '!border-rose-600'); 
        stepEl.classList.add('wrong');
        openBlackboard(q);
      }
    }

    async function openBlackboard(q) {
      const content = document.getElementById('blackboard-content');
      content.innerHTML = `
        <div class="mb-6 p-4 bg-white/5 border-l-4 border-indigo-500 rounded-r-lg">
          <div id="bb-q" class="text-base font-bold text-white leading-tight"></div>
        </div>
        <div id="bb-how" class="text-white/40 italic text-sm mb-8"></div>
        <div id="bb-steps" class="space-y-8"></div>
      `;
      document.getElementById('blackboard').classList.add('active');
      await typeText(document.getElementById('bb-q'), `Question: ${q.questionText}`);
      await typeText(document.getElementById('bb-how'), q.howTo);
      for(let s of q.steps) {
        const stepWrap = document.createElement('div');
        stepWrap.innerHTML = `<div class="bb-step-label"></div><div class="bb-step-text"></div><div class="bb-step-res"></div>`;
        document.getElementById('bb-steps').appendChild(stepWrap);
        await typeText(stepWrap.querySelector('.bb-step-label'), s.label);
        await typeText(stepWrap.querySelector('.bb-step-text'), s.ins);
        await typeText(stepWrap.querySelector('.bb-step-res'), `= ${s.res}`);
        content.scrollTop = content.scrollHeight;
      }
    }

    function typeText(el, text) {
      return new Promise(resolve => {
        let i = 0;
        function tick() {
          if(i < text.length) {
            const s = document.createElement('span'); s.className = 'char';
            s.textContent = text[i++]; el.appendChild(s);
            setTimeout(tick, 12);
          } else { resolve(); }
        }
        tick();
      });
    }

    function nextQuestion() {
      currentQuiz.currentIndex++;
      if(currentQuiz.currentIndex >= 10) {
        document.getElementById('quiz-view').classList.add('hidden');
        document.getElementById('blackboard').classList.remove('active');
        document.getElementById('results-view').classList.remove('hidden');
        document.getElementById('final-score').textContent = `Final Score: ${currentQuiz.score} / 10`;
      } else renderQuestion();
    }

    function showHome() {
      document.getElementById('quiz-view').classList.add('hidden');
      document.getElementById('results-view').classList.add('hidden');
      document.getElementById('blackboard').classList.remove('active');
      document.getElementById('home-view').classList.remove('hidden');
      currentQuiz = null;
      isProcessing = false;
    }
    
    lucide.createIcons();
  </script>
</body>
</html>
